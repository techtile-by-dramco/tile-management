# Part of the redesigned client management system
# Cleans the client home directory
---
- name: Clean home directory safely
  hosts: all
  become: yes
  vars:
    home_user: pi
    home_dir: "/home/{{ home_user }}"
    preserve_dirs:
      - ".ssh"
      - "Documents"
      - "Downloads"
      - "Desktop"
      - "Pictures"
      - "Videos"
      - "Music"
    preserve_files:
      - ".bashrc"
      - ".profile"
    clean_preserve_dirs: true

  tasks:
    - name: Delete all files and directories except .ssh and preserve_dirs/preserve_files
      ansible.builtin.shell: |
        set -e
        for f in {{ home_dir }}/* {{ home_dir }}/.[!.]*; do
          name=$(basename "$f")
          # skip .ssh completely
          if [[ "$f" == "{{ home_dir }}/.ssh"* ]]; then
            continue
          fi
          # skip preserve_dirs themselves
          if [[ " {{ preserve_dirs | join(' ') }} " =~ " $name " ]]; then
            continue
          fi
          # skip preserve_files
          if [[ " {{ preserve_files | join(' ') }} " =~ " $name " ]]; then
            continue
          fi
          rm -rf "$f"
        done
      args:
        executable: /bin/bash

    - name: Empty preserved directories if requested
      ansible.builtin.shell: |
        set -e
        for d in {{ preserve_dirs | join(' ') }}; do
          dir="{{ home_dir }}/$d"
          if [[ -d "$dir" ]] && [[ "$d" != ".ssh" ]]; then
            rm -rf "$dir"/* "$dir"/.[!.]*
          fi
        done
      args:
        executable: /bin/bash
      when: clean_preserve_dirs
