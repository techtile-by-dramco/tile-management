---
- name: Run script asynchronously and check result
  hosts: all
  gather_facts: no
  become: no

  vars:
    default_script_path: "/home/pi/tile-management/tiles/dummy.sh"
    script_timeout: 3600       # max runtime in seconds

    # Optional vars: only use defaults if not supplied via --extra-vars
    use_sudo: "{{ sudo | default(false) }}"
    use_sudo_flags: "{{ sudo_flags | default('') }}"
    use_script_args: "{{ script_args | default('') }}"

  tasks:
    - name: Determine script_path
      ansible.builtin.set_fact:
        script_path: "{{ script_path | default(default_script_path) }}"

    - name: Check if the script exists
      ansible.builtin.stat:
        path: "{{ script_path }}"
      register: script_stat

    - name: Fail if the script does not exist
      ansible.builtin.fail:
        msg: "The script {{ script_path }} does not exist!"
      when: not script_stat.stat.exists

    - name: Ensure the script is executable
      ansible.builtin.file:
        path: "{{ script_path }}"
        mode: "0755"
      when: script_stat.stat.exists

    - name: Run the script asynchronously
      ansible.builtin.command: "{{ script_path }} {{ use_script_args }}"
      become: "{{ use_sudo }}"
      become_flags: "{{ use_sudo_flags }}"
      async: "{{ script_timeout }}"
      poll: 0
      register: async_job
      when: script_stat.stat.exists

    - name: Wait for async job to finish (graceful if job file disappears)
      ansible.builtin.async_status:
        jid: "{{ async_job.ansible_job_id }}"
      register: job_result
      failed_when: false
      changed_when: false
      until: job_result.finished or "could not find job" in job_result.msg | default("")
      retries: "{{ (script_timeout | int) // 10 }}"
      delay: 10
      when: script_stat.stat.exists
  
    - name: Extract stdout safely
      set_fact:
        job_stdout: "{{ job_result.stdout | default('') | trim }}"
      when: script_stat.stat.exists

    - name: Fail if script result does not end with OK
      fail:
        msg: "Script did NOT end with OK (stdout='{{ job_stdout }}')"
      when:
        - script_stat.stat.exists
        - job_stdout is not search('OK$')

    - name: Success message if output ends with OK
      debug:
        msg: "Script ended with OK"
      when:
        - script_stat.stat.exists
        - job_stdout is search('OK$')