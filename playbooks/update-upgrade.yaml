# Part of the redesigned client management system
# Run apt update/upgrade on the client
---
- name: Safely update and upgrade apt packages
  hosts: all
  become: yes
  tasks:

    - name: Wait for apt locks before update
      ansible.builtin.shell: |
        while fuser /var/lib/dpkg/lock-frontend >/dev/null 2>&1 || \
              fuser /var/lib/apt/lists/lock >/dev/null 2>&1 || \
              fuser /var/cache/apt/archives/lock >/dev/null 2>&1; do
          echo "Waiting for apt lock to be released before update..."
          sleep 5
        done
      changed_when: false

    - name: Update apt cache
      ansible.builtin.apt:
        update_cache: yes
        cache_valid_time: 3600

    - name: Wait for apt locks before upgrade
      ansible.builtin.shell: |
        while fuser /var/lib/dpkg/lock-frontend >/dev/null 2>&1 || \
              fuser /var/lib/apt/lists/lock >/dev/null 2>&1 || \
              fuser /var/cache/apt/archives/lock >/dev/null 2>&1; do
          echo "Waiting for apt lock to be released before upgrade..."
          sleep 5
        done
      changed_when: false

    - name: Upgrade all packages
      ansible.builtin.apt:
        upgrade: dist
      register: upgrade_result
      retries: 5
      delay: 10
      until: upgrade_result is succeeded

